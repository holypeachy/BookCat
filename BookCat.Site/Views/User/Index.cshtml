@using BookCat.Site.Controllers
@using Microsoft.AspNetCore.Identity
@model UserController.UserViewModel
@inject UserManager<AppUser> UserManager

@{
    ViewData["Title"] = Model.User.UserName;
}

<div class="user-profile-wrapper">
    <div class="user-profile">
        <div class="user-left">
            @if(string.IsNullOrEmpty(Model.User.UserImageUrl)){
                <img class="profile-picture" src="~/images/default_user.png" alt="User profile picture">
            }
            else
            {
                <a href="@Model.User.UserImageUrl" target="_blank"><img class="profile-picture" src="@Model.User.UserImageUrl" alt="User profile picture"></a>
            }
            <h2>@Model.User.UserName</h2>
        </div>
        <div class="user-details">
            <p>Books Added: @Model.BooksAdded</p>
            <p>Total Reviews: @Model.TotalReviews</p>
            <p>Joined: @(DateOnly.FromDateTime(Model.User.JoinedDateTime))</p>
        </div>
    </div>
    <div class="user-bio">
        <h3>Bio</h3>
        @if(string.IsNullOrEmpty(Model.User.Bio)){
            <p>No Bio</p>
        }
        else{
            <p class="include-new-lines">@Model.User.Bio</p>
        }
    </div>
</div>
<div class="review-card-container">
    <h3>@(Model.User.UserName)'s most recent reviews (@Model.Reviews.Count/@Model.TotalReviews)</h3>
    @foreach (Review review in Model.Reviews){
        <div class="review-card">
            <div class="review-info-profile">
                <a asp-controller="Books" asp-action="Details" asp-route-id="@review.Book.Id">
                    <h3>@review.Book.Title</h3>
                </a>
                <p class="review-title">@review.Title</p>
                <div class="review-stars">
                    @for (int i = 0; i < review.Rating; i++){
                        <span class="material-symbols-outlined on-star"> star_rate </span>
                    }
                    @for (int i = 0; i < 5 - review.Rating; i++){
                        <span class="material-symbols-outlined"> star_rate </span>
                    }
                </div>
                <p>@(DateOnly.FromDateTime(review.PostedAt))</p>
                <p class="review-body include-new-lines">@review.Comment</p>
            </div>
            @{
                var currentUser = await UserManager.GetUserAsync(User);
            }
            @if(currentUser is not null && currentUser.Id == review.UserId){
                <div class="edit-btns">
                    <a class="btn clean-link" asp-controller="Books" asp-action="EditReview" asp-route-id="@review.Id" asp-fragment="WriteReview">Edit</a>
                    <form asp-controller="Books" asp-action="DeleteReview" method="post" onsubmit="return confirm('Are you sure you want to delete this review?');">
                        <input class="hidden" type="text" value="@review.Id" name="id">
                        <input class="hidden" type="text" value="/User/@review.UserId" name="returnUrl">
                        <input class="btn-danger" type="submit" value="Delete">
                    </form>
                </div>
            }
        </div>
    }
</div>
@if(Model.Reviews.Count > 0){
    <div class="pagination-wrapper">
        @if(Model.CurrentPage != 1){
            <a class="pagination-item btn clean-link" asp-controller="User" asp-action="Index" asp-route-id="@Model.User.Id" asp-route-page="@(Model.CurrentPage - 1)">&lt;</a>
        }
        else{
            <span class="pagination-item">&lt;</span>
        }
        @for(int i = 1; i < Model.TotalPages + 1; i++){
            @if(Model.CurrentPage == i){
                <span class="pagination-item current-page clean-link">@i</span>
            }
            else{
                <a class="pagination-item" asp-controller="User" asp-action="Index" asp-route-id="@Model.User.Id" asp-route-page="@i">@i</a>
            }
        }
        @if(Model.CurrentPage != Model.TotalPages){
            <a class="pagination-item btn clean-link" asp-controller="User" asp-action="Index" asp-route-id="@Model.User.Id" asp-route-page="@(Model.CurrentPage + 1)">&gt;</a>
        }
        else{
            <span class="pagination-item">&gt;</span>
        }
    </div>
}


@section Styles{
    <link rel="stylesheet" href="~/css/review.css">
    <link rel="stylesheet" href="~/css/user.css">
    <link rel="stylesheet" href="~/css/pagination.css">
}